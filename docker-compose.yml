# ========================================
# Job Applicant - Docker Compose
# ========================================
#
# Usage:
#   Start all:            docker-compose up -d
#   Start infrastructure: docker-compose up -d user-db auth-db kafka redis eureka-server
#   Stop all:             docker-compose down
#   Reset all DBs:        docker-compose down -v && docker-compose up -d
#
# Eureka Dashboard:      http://localhost:8761
# Kafka UI:              http://localhost:8090
# Redis Commander:       http://localhost:8091
# API Gateway:           http://localhost:8080
# ========================================

services:
    # ========================================
    # Separate PostgreSQL Databases
    # ========================================

    user-db:
        image: postgres:16-alpine
        container_name: ja-user-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: user_db
        ports:
            - "5433:5432"
        volumes:
            - user_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d user_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    auth-db:
        image: postgres:16-alpine
        container_name: ja-auth-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: auth_db
        ports:
            - "5434:5432"
        volumes:
            - auth_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d auth_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    application-db:
        image: postgres:16-alpine
        container_name: ja-application-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: application_db
        ports:
            - "5435:5432"
        volumes:
            - application_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d application_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    notification-db:
        image: postgres:16-alpine
        container_name: ja-notification-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: notification_db
        ports:
            - "5436:5432"
        volumes:
            - notification_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d notification_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    subscription-db:
        image: postgres:16-alpine
        container_name: ja-subscription-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: subscription_db
        ports:
            - "5437:5432"
        volumes:
            - subscription_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d subscription_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    admin-db:
        image: postgres:16-alpine
        container_name: ja-admin-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: admin_db
        ports:
            - "5438:5432"
        volumes:
            - admin_db_data:/var/lib/postgresql/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d admin_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ========================================
    # Service Discovery (Eureka)
    # ========================================

    eureka-server:
        build:
            context: ./services/eureka-server
        image: ja-eureka-server
        container_name: ja-eureka-server
        ports:
            - "8761:8761"
        networks:
            - ja-network
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "-q",
                    "--spider",
                    "http://localhost:8761/actuator/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 5

    # ========================================
    # Kafka Infrastructure
    # ========================================

    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: ja-zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - "2181:2181"
        networks:
            - ja-network
        healthcheck:
            test: ["CMD", "nc", "-z", "localhost", "2181"]
            interval: 10s
            timeout: 5s
            retries: 5

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: ja-kafka
        depends_on:
            zookeeper:
                condition: service_healthy
        ports:
            - "9092:9092"
            - "29092:29092"
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        networks:
            - ja-network
        healthcheck:
            test:
                [
                    "CMD",
                    "kafka-broker-api-versions",
                    "--bootstrap-server",
                    "localhost:9092",
                ]
            interval: 10s
            timeout: 10s
            retries: 5

    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: ja-kafka-ui
        depends_on:
            kafka:
                condition: service_healthy
        ports:
            - "8090:8080"
        environment:
            KAFKA_CLUSTERS_0_NAME: local
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
        networks:
            - ja-network

    # ========================================
    # Redis
    # ========================================

    redis:
        image: redis:7-alpine
        container_name: ja-redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        networks:
            - ja-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
        command: redis-server --appendonly yes

    redis-commander:
        image: rediscommander/redis-commander:latest
        container_name: ja-redis-commander
        depends_on:
            - redis
        ports:
            - "8091:8081"
        environment:
            REDIS_HOSTS: local:redis:6379
        networks:
            - ja-network

    # ========================================
    # Application Services
    # ========================================

    api-gateway:
        build:
            context: ./services/api-gateway
            dockerfile: Dockerfile
        container_name: ja-api-gateway
        ports:
            - "8080:8080"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
            JWT_SECRET: ${JWT_SECRET:-dGhpc2lzYXZlcnlsb25nc2VjcmV0a2V5Zm9yand0dG9rZW5zaWduaW5nYW5kaXRzaG91bGRiZWF0bGVhc3QyNTZiaXRz}
        depends_on:
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    auth-service:
        build:
            context: ./services/auth-service
            dockerfile: Dockerfile
        container_name: ja-auth-service
        ports:
            - "8081:8081"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://auth-db:5432/auth_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
            # JWT configuration
            JWT_SECRET: ${JWT_SECRET:-dGhpc2lzYXZlcnlsb25nc2VjcmV0a2V5Zm9yand0dG9rZW5zaWduaW5nYW5kaXRzaG91bGRiZWF0bGVhc3QyNTZiaXRz}
            JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600000}
            JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-604800000}
            # Activation link base (inside Docker points to API Gateway service)
            APP_URL_ACTIVATION: ${APP_URL_ACTIVATION:-http://api-gateway:8080}
            # Mail settings
            SPRING_MAIL_HOST: ${SPRING_MAIL_HOST:-smtp.gmail.com}
            SPRING_MAIL_PORT: ${SPRING_MAIL_PORT:-587}
            SPRING_MAIL_USERNAME: masterdarius2003@gmail.com
            SPRING_MAIL_PASSWORD: mcxp yrqw qsuk zbax
            SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH:-true}
            SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE:-true}
            SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED:-true}
        depends_on:
            auth-db:
                condition: service_healthy
            kafka:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    user-service:
        build:
            context: ./services/user-service
            dockerfile: Dockerfile
        container_name: ja-user-service
        ports:
            - "8085:8085"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://user-db:5432/user_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
        depends_on:
            user-db:
                condition: service_healthy
            kafka:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    application-service:
        build:
            context: ./services/application-service
            dockerfile: Dockerfile
        container_name: ja-application-service
        ports:
            - "8083:8083"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://application-db:5432/application_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
        depends_on:
            application-db:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    notification-service:
        build:
            context: ./services/notification-service
            dockerfile: Dockerfile
        container_name: ja-notification-service
        ports:
            - "8086:8086"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://notification-db:5432/notification_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
            SPRING_DATA_REDIS_HOST: redis
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
        depends_on:
            notification-db:
                condition: service_healthy
            kafka:
                condition: service_healthy
            redis:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    subscription-service:
        build:
            context: ./services/subscription-service
            dockerfile: Dockerfile
        container_name: ja-subscription-service
        ports:
            - "8087:8087"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://subscription-db:5432/subscription_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
        depends_on:
            subscription-db:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

    admin-service:
        build:
            context: ./services/admin-service
            dockerfile: Dockerfile
        container_name: ja-admin-service
        ports:
            - "8088:8088"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SPRING_DATASOURCE_URL: jdbc:postgresql://admin-db:5432/admin_db
            SPRING_DATASOURCE_USERNAME: postgres
            SPRING_DATASOURCE_PASSWORD: postgres
            EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
        depends_on:
            admin-db:
                condition: service_healthy
            eureka-server:
                condition: service_healthy
        networks:
            - ja-network

networks:
    ja-network:
        driver: bridge

volumes:
    user_db_data:
    auth_db_data:
    application_db_data:
    notification_db_data:
    subscription_db_data:
    admin_db_data:
    redis_data:
